<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Sample FirebaseUI App</title>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js"></script>
    
    <script type="module">
      //const firebase_app_url = "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
      //const firebase_auth_url = "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
      //const firebase_database_url = "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
      import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
      import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyCc0og3bSe6mKvsBIFsoxYOCEmONmEF4P0",
        authDomain: "todacarne-firebase.firebaseapp.com",
        databaseURL: "https://todacarne-firebase-default-rtdb.firebaseio.com",
        projectId: "todacarne-firebase",
        storageBucket: "todacarne-firebase.appspot.com",
        messagingSenderId: "313540425147",
        appId: "1:313540425147:web:08947128762713d577009e",
        measurementId: "G-GL4NXH7Q2R"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      //const analytics = getAnalytics(app);
      
      const provider = new GoogleAuthProvider();
      
      provider.setCustomParameters({
        prompt: "select_account"
      });

      const auth = getAuth();
      var USER_ID = null;
      
      signInWithPopup(auth, provider)
        .then((result) => {
          // This gives you a Google Access Token. You can use it to access the Google API.
          const credential = GoogleAuthProvider.credentialFromResult(result);
          const token = credential.accessToken;
          // The signed-in user info.
          const user = result.user;
          // IdP data available using getAdditionalUserInfo(result)
          const json_user = JSON.stringify(user); 
          
          USER_ID = user.uid;
          
          console.log('token=' + token);
          console.log('user=' + json_user);
          console.log('USER_ID=' + USER_ID);
          console.log('finished_login');
        }).catch((error) => {
          // Handle Errors here.
          const errorCode = error.code;
          const errorMessage = error.message;
          // The email of the user's account used.
          const email = error.customData.email;
          // The AuthCredential type that was used.
          const credential = GoogleAuthProvider.credentialFromError(error);
          
          console.log('errorCode=' + errorCode);
          console.log('errorMessage=' + errorMessage);
          console.log('credential=' + credential);          
        });      

        const database = getDatabase(app);
        
        // firebase apiKey access to Identity Toolkit API
        // Requests to this API identitytoolkit method google.cloud.identitytoolkit.v1.ProjectConfigService.GetProjectConfig are blocked
        
        window.write_jlq = (field, val) => {
            set(ref(database, 'users/' + USER_ID), {
                username: val,
                email: 'el correo de ' + val,
              }).catch((error) => {
            console.error(error);
          });
        };
        
        window.read_jlq = () => {
          const dbRef2 = ref(database, 'users/' + USER_ID + '/username')
          read_fb(dbRef2, "db_read_data");
        }
     
        window.read_jlq_2 = () => {
          const dbRef2 = ref(database, 'users/campo_1')
          read_fb(dbRef2, "db_read_data_2");
        }
        
        const read_fb = (dbRef, field) => {
          onValue(dbRef, (snapshot) => {
            if (snapshot.exists()) {
              //console.log(snapshot.val());
               var the_val = snapshot.val();
               document.getElementById(field).innerText = "THE_VAL=" + the_val;
               console.log('read_fireabase= ' + the_val);
            } else {
               document.getElementById(field).innerText = "No data available";
              console.log("No data available");
            }
          }).catch((error) => {
            console.error(error);
          });        
        
        };
        
        
    </script>       
  </head>
  <body>
    <!-- The surrounding HTML is left untouched by FirebaseUI.
         Your app may use that space for branding, controls and other customizations.-->
    <h1>JLQ AUTH TRY 1</h1>
    <div id="firebaseui-auth-container"></div>
     <div id="login_data">
     </div>

     <h2><a onclick=read_jlq()> READ_TEST </a></h2>
     
     <div id="db_read_data">
     </div>

     <h2><a onclick=write_jlq('nombre','Jose_Luis_Quiroga')> WRITE Jose Luis Quiroga </a></h2>
     <h2><a onclick=write_jlq('nombre','Joluqui')> WRITE Joluqui </a></h2>

     <h2><a onclick=read_jlq_2()> READ_TEST_2 </a></h2>
     
     <div id="db_read_data_2">
     </div>

  </body>
</html>

